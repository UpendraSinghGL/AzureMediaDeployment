{
	"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"utcValue": {
			"type": "string",
			"defaultValue": "[utcNow()]",
			"metadata": {
				"description": "The pricing tier for the hosting plan."
			}
		}
	},
	"variables": {
		"identityName": "durinmedia-identity",
		"cliResourceName": "AzCLIAppRegDeploymentScript",
		"appName": "durinarmapp",
		"appServicePlanName": "[concat('Plan-', variables('appName'))]",
		"aadAppUri": "[concat('https://', variables('appName'), 'azurewebsites.net')]",
		"aadAppRedirectUri": "[concat('https://', variables('appName'), 'azurewebsites.net/signin-oidc')]",
		"cliArg": "[concat(variables('appName'), ' ', variables('aadAppUri'), ' ', variables('aadAppRedirectUri'))]",
		"Reader": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Authorization/roleDefinitions/', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]"
	},
	"resources": [
		{
			"type": "Microsoft.ManagedIdentity/userAssignedIdentities",
			"name": "[variables('identityName')]",
			"apiVersion": "2018-11-30",
			"location": "[resourceGroup().location]"
		},
		{
			"type": "Microsoft.Authorization/roleAssignments",
			"apiVersion": "2018-09-01-preview",
			"name": "[guid(resourceGroup().id)]",
			"properties": {
				"roleDefinitionId": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Authorization/roleDefinitions/', variables('Reader'))]",
				"principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities/',variables('identityName')), '2018-11-30', 'Full').identity.principalId]"
			},
			"dependsOn": [
				"[resourceID('Microsoft.ManagedIdentity/userAssignedIdentities/',variables('identityName'))]"
			]
		},
		{
			"type": "Microsoft.Resources/deploymentScripts",
			"apiVersion": "2019-10-01-preview",
			"name": "[variables('cliResourceName')]",
			"location": "[resourceGroup().location]",
			"kind": "AzureCLI",
			"identity": {
				"type": "UserAssigned",
				"userAssignedIdentities": {
					"[resourceID('Microsoft.ManagedIdentity/userAssignedIdentities/',variables('identityName'))]": {}
				}
			},
			"properties": {
				"forceUpdateTag": "[parameters('utcValue')]",
				"AzCliVersion": "2.0.80",
				"timeout": "PT30M",
				"arguments": "[variables('cliArg')]",
				"scriptContent": "
        appInfo=$(az ad app create --display-name $1 --identifier-uris \"$2\" --reply-urls \"$3\")
        echo $appInfo > $AZ_SCRIPTS_OUTPUT_PATH
			",
				"cleanupPreference": "OnSuccess",
				"retentionInterval": "P1D"
			},
			"dependsOn": [
				"[resourceID('Microsoft.ManagedIdentity/userAssignedIdentities/',variables('identityName'))]"
			]
		}
	]
}