{
	"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"utcValue": {
			"type": "string",
			"defaultValue": "[utcNow()]",
			"metadata": {
				"description": "The pricing tier for the hosting plan."
			}
		}
	},
	"variables": {
		"identityName": "durinmedia-identity",
		"scriptName": "[concat('powerShellAppReg',parameters('utcValue'))]",
		"roleAssignmentId": "[guid(resourceGroup().id)]",
		"appName": "durinarmapp",
		"appServicePlanName": "[concat('Plan-', variables('appName'))]",
		"aadAppUri": "[concat('https://', variables('appName'), 'azurewebsites.net')]",
		"aadAppRedirectUri": "[concat('https://', variables('appName'), 'azurewebsites.net/signin-oidc')]",
		"cliArg": "[concat(variables('appName'))]",
		"Contributor": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Authorization/roleDefinitions/', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
		"Reader": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Authorization/roleDefinitions/', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]"
	},
	"resources": [
		{
			"type": "Microsoft.ManagedIdentity/userAssignedIdentities",
			"name": "[variables('identityName')]",
			"apiVersion": "2018-11-30",
			"location": "[resourceGroup().location]"
		},
		{
			"type": "Microsoft.Authorization/roleAssignments",
			"apiVersion": "2018-09-01-preview",
			"name": "[variables('RoleAssignmentId')]",
			"properties": {
				"roleDefinitionId": "[variables('Contributor')]",
				"principalId": "[reference(concat('Microsoft.ManagedIdentity/userAssignedIdentities/',variables('identityName')),'2015-08-31-PREVIEW').principalId]",
				"scope": "[resourceGroup().id]",
				"principalType": "ServicePrincipal"
			},
			"dependsOn": [
				"[resourceID('Microsoft.ManagedIdentity/userAssignedIdentities/',variables('identityName'))]"
			]
		},
		{
			"type": "Microsoft.Resources/deploymentScripts",
			"apiVersion": "2020-10-01",
			"name": "[variables('scriptName')]",
			"location": "[resourceGroup().location]",
			"kind": "AzurePowerShell",
			"identity": {
				"type": "userAssigned",
				"userAssignedIdentities": {
					"[resourceID('Microsoft.ManagedIdentity/userAssignedIdentities/',variables('identityName'))]": {}
				}
			},
			"properties": {
				"forceUpdateTag": "[parameters('utcValue')]",
				"azPowerShellVersion": "3.0",
				"timeout": "PT30M",
				"arguments": "",
				"scriptContent": "
					Connect-AzureAD
					New-AzureADApplication -DisplayName DurinPowerApp",
				"cleanupPreference": "OnExpiration",
				"retentionInterval": "P1D"
			},
			"dependsOn": [
				"[resourceID('Microsoft.Authorization/roleAssignments/',variables('RoleAssignmentId'))]"
			]
		}
	],
	"outputs": {
		"result": {
			"value": "[reference(variables('scriptName')).status]",
			"type": "object"
		}
	}
}